# Pi-Flow + Self-Forcing (PiSF) Training Config - GMM Policy
# Combines pi-flow velocity matching loss with DMD distribution matching loss
# DMD timestep sampling is segment-aware (constrained to current denoising segment)

# ------------------------------------------------------------
# Training Settings
# ------------------------------------------------------------
max_steps: 10000
log_iters: 500
visualize_init: true     # Generate teacher/student samples before training
teacher_init_nfe: 64     # NFE for teacher init video

# Loss configuration (set scale to 0.0 to disable)
piflow_loss_scale: 1.0   # Pi-flow L2 velocity matching loss scale
dmd_loss_scale: 1.0      # DMD distribution matching loss scale (segment-aware sampling)
dfake_gen_update_ratio: 5

# Sampling configuration
sampling_type: piflow    # 'dmd' (predict-and-resample) or 'piflow' (ODE integration)
x0_pred_type: piflow     # 'dmd' (direct prediction) or 'piflow' (ODE integration to σ≈0)

# ------------------------------------------------------------
# Pi-flow + DMD Settings
# ------------------------------------------------------------
distribution_loss: piflow
config_name: pisf_gmm
trainer: piflow

# Policy Settings
policy_type: gmm         # 'gmm' (Gaussian Mixture Model) or 'dx' (Direct x0 grid)
integration_nfe: 64      # Number of function evaluations for ODE integration

# Policy head configuration
policy_head_cfg:
  K: 32                  # Number of Gaussians
  latent_c: 16           # Latent channels
  patch_size: [1, 2, 2]  # Patch size for operations
  gm_num_logstd_layers: 2
  logstd_inner_dim: 256
  init_logstd: 0.05
  use_patch_distance: false
  use_patch_K: false

# ------------------------------------------------------------
# Video Shape Settings
# ------------------------------------------------------------
image_or_video_shape:
- 1
- 21                     # Number of frames
- 16                     # Latent channels
- 60                     # Height
- 104                    # Width
num_training_frames: 21

# ------------------------------------------------------------
# Self-forcing Settings
# ------------------------------------------------------------
gradient_checkpointing: true
model_kwargs:
  timestep_shift: 5.0
num_frame_per_block: 3
same_step_across_blocks: true
independent_first_frame: false
last_step_only: false
context_noise: 0
backward_simulation: true
load_raw_video: false

# ------------------------------------------------------------
# Model Settings
# ------------------------------------------------------------
generator_ckpt: checkpoints/ode_init.pt
generator_fsdp_wrap_strategy: size
real_score_fsdp_wrap_strategy: size
fake_score_fsdp_wrap_strategy: size
text_encoder_fsdp_wrap_strategy: size
real_name: Wan2.1-T2V-14B

# ------------------------------------------------------------
# Denoising Steps
# ------------------------------------------------------------
denoising_step_list:
- 1000
- 750
- 500
- 250
warp_denoising_step: true
ts_schedule: false
num_train_timestep: 1000
timestep_shift: 5.0
guidance_scale: 3.0
denoising_loss_type: flow

# ------------------------------------------------------------
# Optimization Settings
# ------------------------------------------------------------
lr: 2.0e-06
lr_critic: 4.0e-07
beta1: 0.0
beta2: 0.999
beta1_critic: 0.0
beta2_critic: 0.999
weight_decay: 0.0
max_grad_norm_generator: 10.0
max_grad_norm_critic: 10.0

# ------------------------------------------------------------
# Training Infrastructure
# ------------------------------------------------------------
mixed_precision: true
seed: 0
sharding_strategy: hybrid_full
batch_size: 1
total_batch_size: 64
ema_weight: 0.99
ema_start_step: 200
gc_interval: 50

# ------------------------------------------------------------
# Data and Logging
# ------------------------------------------------------------
data_path: prompts/vidprom_filtered_extended.txt
wandb_project: self_forcing_pisf
negative_prompt: '色调艳丽，过曝，静态，细节模糊不清，字幕，风格，作品，画作，画面，静止，整体发灰，最差质量，低质量，JPEG压缩残留，丑陋的，残缺的，多余的手指，画得不好的手部，画得不好的脸部，畸形的，毁容的，形态畸形的肢体，手指融合，静止不动的画面，杂乱的背景，三条腿，背景人很多，倒着走'

# Visualization
no_visualize: false
no_save: false
save_gif: true

# I2V mode (disabled by default)
i2v: false
causal: true
disable_wandb: false
